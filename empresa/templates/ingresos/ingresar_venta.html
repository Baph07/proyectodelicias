    {% extends "base.html" %}

    {% block content %}
    <div class="form-container">
        <div class="form-card">
            <h2>Ingresar Venta</h2>
            <form method="POST">
                {% csrf_token %}

                <!-- Selección de Categoría -->
                <div class="form-group">
                    <label for="categoria">Categoría</label>
                    <select name="categoria" id="categoria" class="input" onchange="this.form.submit()">
                        <option value="">-- Selecciona categoría --</option>
                        {% for cat in categorias %}
                            <option value="{{ cat }}" {% if categoria_seleccionada == cat %}selected{% endif %}>{{ cat }}</option>
                        {% endfor %}
                    </select>
                </div>

                <!-- ===== HELADOS ===== -->
                {% if categoria_seleccionada == 'Helados' %}
                    <div class="form-group">
                        <label for="tipo_helado">Tipo de Helado</label>
                        <select name="tipo_helado" class="input" onchange="this.form.submit()">
                            <option value="">-- Selecciona tipo --</option>
                            {% for tipo in tipos_helados %}
                                <option value="{{ tipo }}" {% if tipo_helado_seleccionado == tipo %}selected{% endif %}>{{ tipo }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="sabor1">Sabor 1</label>
                        <select name="sabor1" class="input">
                            <option value="">-- Selecciona sabor --</option>
                            {% for sabor in sabores %}
                                <option value="{{ sabor }}">{{ sabor }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    {% if tipo_helado_seleccionado in doble_sabor %}
                    <div class="form-group">
                        <label for="sabor2">Sabor 2</label>
                        <select name="sabor2" class="input">
                            <option value="">-- Selecciona sabor --</option>
                            {% for sabor in sabores %}
                                <option value="{{ sabor }}">{{ sabor }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    {% endif %}

                    <div class="form-group">
                        <label for="cantidad">Cantidad</label>
                        <input type="number" name="cantidad" min="1" value="1" class="input">
                    </div>
                {% endif %}

                <!-- ===== POSTRES ===== -->
                {% if categoria_seleccionada == 'Postres' %}
                    <div class="form-group">
                        <label for="tipo_postre">Tipo de Postre</label>
                        <select name="tipo_postre" class="input" onchange="this.form.submit()">
                            <option value="">-- Selecciona tipo --</option>
                            {% for tipo in postres.keys %}
                                <option value="{{ tipo }}" {% if postre_seleccionado == tipo %}selected{% endif %}>{{ tipo }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    {% if postre_seleccionado %}
                        <div class="form-group">
                            <label for="tamaño">Tamaño</label>
                            <select name="tamaño" class="input">
                                <option value="">-- Selecciona tamaño --</option>
                                {% for tam in tamaños_postre %}
                                    <option value="{{ tam }}" {% if request.POST.tamaño == tam %}selected{% endif %}>{{ tam }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        {% if sabores_postre %}
                        <div class="form-group">
                            <label for="sabor1">Sabor</label>
                            <select name="sabor1" class="input">
                                <option value="">-- Selecciona sabor --</option>
                                {% for s in sabores_postre %}
                                    <option value="{{ s }}" {% if request.POST.sabor1 == s %}selected{% endif %}>{{ s }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        {% endif %}

                        <div class="form-group">
                            <label for="cantidad">Cantidad</label>
                            <input type="number" name="cantidad" min="1" value="1" class="input">
                        </div>
                    {% endif %}
                {% endif %}

                <!-- ===== OTROS ===== -->
                {% if categoria_seleccionada == 'Otros' %}
                    <div class="form-group">
                        <label for="nombre">Producto</label>
                        <select name="nombre" class="input">
                            <option value="">-- Selecciona producto --</option>
                            {% for p in otros %}
                                <option value="{{ p }}" {% if request.POST.nombre == p %}selected{% endif %}>{{ p }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="cantidad">Cantidad</label>
                        <input type="number" name="cantidad" min="1" value="1" class="input">
                    </div>
                {% endif %}

                <button type="submit" name="agregar_producto" class="btn btn-primary">
                    Agregar Producto
                </button>

                {% if venta_temp %}
                    <button
                        type="submit"
                        name="registrar_venta"
                        class="btn btn-success"
                        {% if not venta_temp %}disabled{% endif %}
                    >
                        Registrar Venta
                    </button>

                    <a href="{% url 'borrar_venta_temp' %}"
                    class="btn btn-danger"
                    onclick="return confirm('¿Seguro que deseas borrar toda la venta?');">
                        Borrar Venta
                    </a>

                {% endif %}
            </form>

            {% if venta_temp %}
            <h3>Productos agregados:</h3>
            <ul>
                {% for p in venta_temp %}
                    <li>
                        {% if p.categoria == 'Helados' %}
                            {{ p.cantidad }} x {{ p.tipo_helado }} ({{ p.sabor1 }}{% if p.sabor2 %}, {{ p.sabor2 }}{% endif %})
                        {% elif p.categoria == 'Postres' %}
                            {{ p.cantidad }} x {{ p.tipo_postre }} {% if p.tamaño %}({{ p.tamaño }}){% endif %} {% if p.sabor1 %}- {{ p.sabor1 }}{% endif %}
                        {% else %}
                            {{ p.cantidad }} x {{ p.nombre }}
                        {% endif %}
                        — ${{ p.precio_unitario }} c/u → <strong>${{ p.subtotal }}</strong>

                        <a href="{% url 'eliminar_producto_temp' forloop.counter0 %}"
                        class="btn btn-sm btn-danger"
                        style="margin-left:10px;"
                        onclick="return confirm('¿Eliminar este producto de la venta?');">
                            ❌ Eliminar
                        </a>

                    </li>
                {% endfor %}

            </ul>

            <p><strong>Total acumulado:</strong> ${{ total_venta }}</p>
            {% endif %}
        </div>
    </div>
    {% endblock %}
